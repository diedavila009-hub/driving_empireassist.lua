<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Driving Empire — Race Analyzer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    canvas { border: 1px solid #ccc; margin-top: 20px; }
    textarea { width: 100%; }
    #stats p { margin: 5px 0; }
    .verde { color: green; }
    .amarillo { color: goldenrod; }
    .naranja { color: orange; }
    .rojo { color: red; }
  </style>
</head>
<body>
  <h1>Driving Empire — Race Analyzer</h1>
  <p>Carga tu JSON desde Roblox, visualizá el trazado, evaluá el desempeño y guardá múltiples laps.</p>

  <!-- Cargar archivo JSON -->
  <h3>Cargar JSON desde archivo</h3>
  <input type="file" id="fileInput" accept=".json">
  <button onclick="loadJsonFromFile()">Cargar archivo</button>

  <!-- Cargar JSON pegando texto -->
  <h3>Pegar JSON</h3>
  <textarea id="jsonInput" rows="10" cols="50" placeholder='Pega aquí tu JSON'></textarea>
  <br>
  <button onclick="loadJsonFromText()">Cargar desde texto</button>

  <!-- Canvas para dibujar el circuito -->
  <h3>Recorrido</h3>
  <canvas id="raceCanvas" width="800" height="600"></canvas>

  <!-- Gráfico de velocidad -->
  <h3>Velocidad vs Tiempo</h3>
  <canvas id="speedCanvas" width="800" height="300"></canvas>

  <!-- Estadísticas -->
  <h3>Estadísticas del lap</h3>
  <div id="stats"></div>

  <!-- Ranking -->
  <div id="ranking"></div>

  <script>
    let laps = [];

    // Procesar JSON desde archivo
    function loadJsonFromFile() {
      const input = document.getElementById("fileInput");
      if (input.files.length === 0) {
        alert("Selecciona un archivo JSON primero.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          processJson(data);
        } catch (err) {
          alert("El archivo no es un JSON válido: " + err.message);
        }
      };
      reader.readAsText(input.files[0]);
    }

    // Procesar JSON desde texto pegado
    function loadJsonFromText() {
      try {
        const text = document.getElementById("jsonInput").value;
        const data = JSON.parse(text);
        processJson(data);
      } catch (err) {
        alert("El JSON no es válido: " + err.message);
      }
    }

    // Función principal para manejar los datos
    function processJson(data) {
      // Calcular estadísticas
      const duration = data[data.length - 1].time - data[0].time;
      const maxSpeed = Math.max(...data.map(p => p.speed));
      const avgSpeed = data.reduce((s,p)=>s+p.speed,0)/data.length;
      const collisions = data.filter(p=>p.collision).length;

      // Guardar lap
      laps.push({data, duration, maxSpeed, avgSpeed, collisions});

      // Dibujar recorrido
      drawTrack(data);

      // Dibujar gráfico de velocidad
      drawSpeedGraph(data);

      // Mostrar estadísticas
      showStats(duration, maxSpeed, avgSpeed, collisions);

      // Actualizar ranking
      updateRanking();
    }

    // Dibujar recorrido
    function drawTrack(data) {
      const canvas = document.getElementById("raceCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      data.forEach((point, index) => {
        const x = point.pos.x * 10; // escala simple
        const y = point.pos.z * 10; // usamos z como eje vertical
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.strokeStyle = "blue";
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // Dibujar gráfico de velocidad vs tiempo
    function drawSpeedGraph(data) {
      const canvas = document.getElementById("speedCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.beginPath();
      data.forEach((point,i)=>{
        const x = point.time * 50; // escala tiempo
        const y = canvas.height - point.speed * 5; // escala velocidad
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.strokeStyle = "red";
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // Mostrar estadísticas
    function showStats(duration, maxSpeed, avgSpeed, collisions) {
      document.getElementById("stats").innerHTML = `
        <p>Duración: ${duration.toFixed(2)}s</p>
        <p>Velocidad máxima: ${maxSpeed.toFixed(2)}</p>
        <p>Velocidad promedio: ${avgSpeed.toFixed(2)}</p>
        <p>Colisiones: ${collisions}</p>
      `;
    }

    // Ranking de mejores tiempos
    function updateRanking() {
      const rankingDiv = document.getElementById("ranking");
      const sorted = [...laps].sort((a,b)=>a.duration - b.duration);
      rankingDiv.innerHTML = "<h3>Ranking de tiempos</h3>";
      sorted.forEach((lap,i)=>{
        rankingDiv.innerHTML += `<p>#${i+1} - ${lap.duration.toFixed(2)}s (Vel. prom: ${lap.avgSpeed.toFixed(2)})</p>`;
      });
    }
  </script>
</body>
</html>
