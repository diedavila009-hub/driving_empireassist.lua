<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ULTRALYTICS AI - GESTOR DE CARRERAS Y TELEMETR√çA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon: #00f2ff; --bg: #050505; --card: #111; --border: #222; }
        body { background: var(--bg); color: var(--neon); font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; }
        .dashboard { max-width: 1200px; margin: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .full { grid-column: 1 / -1; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h2, h3 { margin-top: 0; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Input y Botones */
        textarea { width: 100%; height: 60px; background: #000; border: 1px solid var(--neon); color: #0f8; border-radius: 8px; padding: 10px; box-sizing: border-box; font-family: monospace; font-size: 12px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 12px; background: var(--neon); color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #00b8c4; transform: scale(1.01); }
        
        /* Stats */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 15px; }
        .stat-item { padding: 8px; background: #000; border-radius: 6px; border-bottom: 2px solid var(--neon); }
        .val { font-size: 22px; color: #fff; display: block; font-weight: 800; }
        label { font-size: 10px; color: #888; font-weight: bold; text-transform: uppercase; }

        /* IA Box */
        .ai-box { background: rgba(0, 242, 255, 0.05); border: 1px dashed var(--neon); padding: 15px; border-radius: 8px; line-height: 1.5; min-height: 100px; }
        
        /* Historial */
        .history-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--neon) transparent; }
        .history-list::-webkit-scrollbar { width: 8px; }
        .history-list::-webkit-scrollbar-track { background: transparent; }
        .history-list::-webkit-scrollbar-thumb { background-color: var(--neon); border-radius: 10px; border: 2px solid var(--card); }
        
        .history-item { 
            background: #000; padding: 10px; border-radius: 8px; margin-bottom: 8px; 
            border-left: 4px solid var(--neon); font-size: 13px; cursor: pointer; 
            display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s;
        }
        .history-item:hover { background: #1a1a1a; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,242,255,0.2); }
        .history-info { flex-grow: 1; }
        .history-info b { color: #fff; font-size: 15px; }
        .history-info small { color: #aaa; }
        .history-map { width: 60px; height: 40px; background: #333; border-radius: 4px; margin-left: 10px; }
        
        /* Canvas y Charts */
        canvas { width: 100% !important; background: #000; border-radius: 8px; }
        .status-msg { text-align: center; font-weight: bold; margin-top: 10px; font-size: 14px; }

        /* Bot√≥n borrar historial */
        .clear-history-btn { background: #555; margin-top: 15px; font-size: 11px; padding: 8px; }
        .clear-history-btn:hover { background: #777; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full">
        <h2>üõ∞Ô∏è ULTRALYTICS AI: GESTOR DE CARRERAS</h2>
        <textarea id="dataInput" placeholder="Pega los datos de la vuelta aqu√≠ (desde Roblox)..."></textarea>
        <button class="btn" onclick="procesarNuevaVuelta()">IDENTIFICAR Y ANALIZAR VUELTA</button>
        <div id="status" class="status-msg"></div>
    </div>

    <div class="card">
        <h3>üìä RENDIMIENTO ACTUAL</h3>
        <div class="stat-grid">
            <div class="stat-item"><label>VEL. M√ÅX</label><span id="top-speed" class="val">0</span></div>
            <div class="stat-item"><label>FUERZA G</label><span id="max-g" class="val">0</span></div>
            <div class="stat-item"><label>MUESTRAS</label><span id="samples" class="val">0</span></div>
        </div>
        <div class="stat-grid">
            <div class="stat-item"><label>CHOQUES</label><span id="collisions" class="val" style="color:#ff4444;">0</span></div>
            <div class="stat-item"><label>DERRAPES</label><span id="skids" class="val" style="color:#ffd700;">0</span></div>
            <div class="stat-item"><label>MANEJO</label><span id="corrections" class="val" style="color:#00ff88;">--</span></div>
        </div>
    </div>

    <div class="card">
        <h3>ü§ñ IA DE RECONOCIMIENTO Y CONSEJOS</h3>
        <div id="ai-status" class="ai-box">Esperando datos para identificar pista...</div>
    </div>

    <div class="card full">
        <h3>üó∫Ô∏è MAPA T√âRMICO DE TRAYECTORIA</h3>
        <canvas id="mapCanvas"></canvas>
    </div>

    <div class="card full">
        <h3>üìà AN√ÅLISIS DE TELEMETR√çA (Velocidad, Acelerador, Giro)</h3>
        <canvas id="telemetryChart"></canvas>
    </div>

    <div class="card full">
        <h3>üìÅ HISTORIAL DE VUELTAS GUARDADAS</h3>
        <ul id="historyList" class="history-list"></ul>
        <button class="btn clear-history-btn" onclick="borrarHistorial()">BORRAR TODO EL HISTORIAL</button>
    </div>
</div>

<script>
let database = JSON.parse(localStorage.getItem('race_db')) || [];
let mainChart = null; // Gr√°fica principal de telemetr√≠a
let currentMap = null; // Referencia al mapa principal

window.onload = actualizarListaUI;

function procesarNuevaVuelta() {
    let raw = document.getElementById('dataInput').value.trim();
    const status = document.getElementById('status');
    status.innerText = ""; // Limpiar estado anterior

    try {
        // --- MOTOR DE REPARACI√ìN DE EMERGENCIA ---
        let lastValid = raw.lastIndexOf('}');
        if (lastValid === -1) throw "Incompleto";
        raw = raw.substring(0, lastValid + 1);
        if (!raw.startsWith('[')) raw = '[' + raw;
        if (!raw.endsWith(']')) raw = raw + ']';

        const data = JSON.parse(raw);
        status.innerText = "‚úÖ Datos procesados con √©xito.";
        status.style.color = "#00ff88";

        renderDashboard(data); // Actualiza los stats y los gr√°ficos principales
        analizarConIA(data);   // Ejecuta la l√≥gica de la IA
        
    } catch (e) {
        status.innerText = "‚ùå ERROR: Datos corruptos o insuficientes. Copia desde el inicio hasta el final.";
        status.style.color = "#ff4444";
        console.error("Error al procesar datos:", e);
    }
}

function renderDashboard(data) {
    // Calcular estad√≠sticas para el panel superior
    const speeds = data.map(d => d.speed);
    const gForces = data.map(d => Math.abs(d.deltaV || 0) / 10); // deltaV / (intervalo * g) = g-force
    const collisionCount = data.filter(d => d.collision || d.deltaV > 12).length;
    const skidCount = data.filter(d => d.skid || d.lateralSpeed > 6).length;
    
    document.getElementById('top-speed').innerText = Math.max(...speeds).toFixed(1) + " ST/S";
    document.getElementById('max-g').innerText = Math.max(...gForces).toFixed(2) + "G";
    document.getElementById('samples').innerText = data.length;
    document.getElementById('collisions').innerText = collisionCount;
    document.getElementById('skids').innerText = skidCount;
    document.getElementById('corrections').innerText = (skidCount > 0 || collisionCount > 0) ? "VERIFICAR" : "√ìPTIMO";


    drawMap(data, document.getElementById('mapCanvas')); // Mapa principal
    drawChart(data); // Gr√°fica principal
}

function analizarConIA(newData) {
    const aiStatus = document.getElementById('ai-status');
    const avgX = newData[0].pos.x; // Usamos el punto de inicio como referencia de pista
    const avgZ = newData[0].pos.z;
    const currentTopSpeed = Math.max(...newData.map(d => d.speed));
    
    let pistaExistente = database.find(r => Math.abs(r.coords.x - avgX) < 500 && Math.abs(r.coords.z - avgZ) < 500);
    
    let nombrePista = pistaExistente ? pistaExistente.nombre : "Pista Nueva " + (database.length + 1);
    let comparativa = "";
    let esNuevoRecord = false;

    if (pistaExistente) {
        let diferencia = currentTopSpeed - pistaExistente.topSpeed;
        if (diferencia > 0) {
            comparativa = `<b style="color:#0f8">üìà ¬°NUEVO R√âCORD! Eres ${diferencia.toFixed(1)} ST/S m√°s r√°pido.</b>`;
            esNuevoRecord = true;
        } else {
            comparativa = `<b style="color:#f44">üìâ Eres ${Math.abs(diferencia).toFixed(1)} ST/S m√°s lento que tu mejor marca.</b>`;
        }
    } else {
        comparativa = "‚ú® Primera vez detectada en esta ubicaci√≥n. Guardando trazado...";
        esNuevoRecord = true; // Si es pista nueva, es un "r√©cord" inicial
    }

    // Guardar en la base de datos (solo si es nuevo r√©cord o pista nueva)
    if (esNuevoRecord) {
        // Si ya exist√≠a un r√©cord para esta pista, lo eliminamos antes de a√±adir el nuevo
        if(pistaExistente) {
            database = database.filter(r => !(Math.abs(r.coords.x - avgX) < 500 && Math.abs(r.coords.z - avgZ) < 500));
        }

        const nuevaEntrada = {
            id: Date.now(),
            nombre: nombrePista,
            topSpeed: currentTopSpeed,
            coords: {x: avgX, z: avgZ},
            fecha: new Date().toLocaleString(),
            data: newData // Guardamos la telemetr√≠a completa
        };
        database.push(nuevaEntrada);
        localStorage.setItem('race_db', JSON.stringify(database));
    }

    aiStatus.innerHTML = `
        <b>UBICACI√ìN DETECTADA:</b> ${nombrePista}<br>
        <b>VELOCIDAD PUNTA ACTUAL:</b> ${currentTopSpeed.toFixed(1)} ST/S<br>
        ${comparativa}<br><br>
        <i>üí° CONSEJO IA: ${generarConsejo(newData)}</i>
    `;

    actualizarListaUI(); // Re-renderizar la lista para mostrar la nueva entrada o el record actualizado
}

function generarConsejo(data) {
    const collisions = data.filter(d => d.collision).length;
    const skids = data.filter(d => d.skid).length;
    
    if (collisions > 0) {
        return "Demasiados impactos. Prioriza la trazada limpia para mantener la velocidad.";
    }
    if (skids > 15) {
        return "El coche derrapa mucho. Controla mejor el acelerador o reduce el √°ngulo de giro.";
    }
    const avgThrottle = data.reduce((sum, d) => sum + (d.throttle || 0), 0) / data.length;
    if (avgThrottle < 0.5) {
        return "Podr√≠as acelerar m√°s. Mantener el pie a fondo te dar√° ventaja en las rectas.";
    }
    const maxDeltaV = Math.max(...data.map(d => Math.abs(d.deltaV || 0)));
    if (maxDeltaV < 5 && data.length > 50) { // Si casi no hay aceleraci√≥n/frenado brusco
        return "Conducci√≥n muy suave. Busca puntos de frenado m√°s agresivos para optimizar el tiempo.";
    }
    return "¬°Conducci√≥n eficiente! Mant√©n este ritmo y busca pulir cada mil√©sima.";
}

function actualizarListaUI() {
    const list = document.getElementById('historyList');
    list.innerHTML = "";
    // Ordenar por el √∫ltimo registro (m√°s reciente primero)
    database.sort((a,b) => b.id - a.id).forEach(race => {
        const li = document.createElement('li');
        li.className = "history-item";
        li.onclick = () => { 
            renderDashboard(race.data); // Mostrar datos en el panel principal
            document.getElementById('ai-status').innerHTML = `
                <b>HISTORIAL:</b> ${race.nombre}<br>
                <b>VELOCIDAD PUNTA:</b> ${race.topSpeed.toFixed(1)} ST/S<br>
                <small>Fecha: ${race.fecha}</small><br><br>
                <i>üí° CONSEJO IA: ${generarConsejo(race.data)}</i>
            `;
        };

        const infoDiv = document.createElement('div');
        infoDiv.className = "history-info";
        infoDiv.innerHTML = `<b>${race.nombre}</b> - ${race.topSpeed.toFixed(1)} ST/S <br> <small>${race.fecha}</small>`;
        li.appendChild(infoDiv);

        // Canvas para el minimapa
        const miniMapCanvas = document.createElement('canvas');
        miniMapCanvas.className = "history-map";
        miniMapCanvas.width = 60; // Tama√±o fijo para el minimapa
        miniMapCanvas.height = 40;
        li.appendChild(miniMapCanvas);
        
        list.appendChild(li);
        drawMap(race.data, miniMapCanvas); // Dibujar en el minimapa
    });
}

// Funci√≥n general para dibujar mapas (ahora acepta cualquier canvas)
function drawMap(data, targetCanvas) {
    const ctx = targetCanvas.getContext('2d');
    
    // Obtener l√≠mites
    const xs = data.map(d => d.pos.x), zs = data.map(d => d.pos.z);
    const minX = Math.min(...xs), maxX = Math.max(...xs), minZ = Math.min(...zs), maxZ = Math.max(...zs);
    const rangeX = maxX - minX || 1;
    const rangeZ = maxZ - minZ || 1;

    // Calcular escala para que se ajuste al canvas peque√±o
    const padding = 5;
    const scale = Math.min((targetCanvas.width - padding*2) / rangeX, (targetCanvas.height - padding*2) / rangeZ);

    ctx.clearRect(0,0,targetCanvas.width,targetCanvas.height);
    
    for(let i=1; i<data.length; i++) {
        const p1 = data[i-1], p2 = data[i];
        ctx.beginPath();
        ctx.lineWidth = targetCanvas.width === 60 ? 1 : (p2.collision ? 8 : 4); // M√°s fino para minimapa
        
        // Color por velocidad (Azul -> Rojo)
        const hue = Math.max(0, 200 - (p2.speed * 1.5));
        ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
        
        // Ajustar coordenadas
        ctx.moveTo((p1.pos.x-minX)*scale+padding, (p1.pos.z-minZ)*scale+padding);
        ctx.lineTo((p2.pos.x-minX)*scale+padding, (p2.pos.z-minZ)*scale+padding);
        ctx.stroke();
    }
}

function drawChart(data) {
    const ctx = document.getElementById('telemetryChart').getContext('2d');
    if(mainChart) mainChart.destroy();

    mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.time.toFixed(1) + "s"),
            datasets: [
                { label: 'Velocidad (ST/S)', data: data.map(d => d.speed), borderColor: '#00f2ff', borderWidth: 2, pointRadius: 0 },
                { label: 'Acelerador (%)', data: data.map(d => (d.throttle || 0) * 100), borderColor: '#00ff88', borderWidth: 1, fill: true, backgroundColor: 'rgba(0,255,136,0.05)', pointRadius: 0 },
                { label: 'Volante (%)', data: data.map(d => (d.steer || 0) * 100), borderColor: '#ff00ff', borderWidth: 1, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#fff' } } },
            scales: {
                y: { grid: { color: '#222' }, ticks: { color: '#888' } },
                x: { grid: { display: false }, ticks: { color: '#888' } }
            }
        }
    });
}

function borrarHistorial() {
    if(confirm("¬øEst√°s seguro de que quieres borrar TODO el historial de carreras? Esta acci√≥n es irreversible.")) {
        localStorage.removeItem('race_db');
        database = [];
        actualizarListaUI();
        document.getElementById('status').innerText = "Historial borrado.";
        document.getElementById('status').style.color = "#ff4444";
    }
}
</script>
</body>
</html>
