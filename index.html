<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Driving Empire — Race Analyzer Pro</title>
  <style>
    :root {
      --bg: #0f1222; --panel: #1a1f36; --text: #e6e6f0;
      --muted: #9aa0aa; --accent: #32a852; --warn: #f0a000;
      --danger: #e24a4a; --info: #2a84e8;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0; padding: 20px; background: var(--bg); color: var(--text);
    }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 1100px) { .grid { grid-template-columns: 350px 1fr; } }
    .panel { background: var(--panel); border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    textarea { 
      width: 100%; background: #0b1026; color: #50fa7b; border: 1px solid #2a3457; 
      border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; resize: vertical;
    }
    button { 
      width: 100%; cursor: pointer; padding: 12px; border-radius: 8px; border: none; 
      font-weight: bold; margin-top: 8px; transition: 0.2s;
    }
    .primary { background: var(--info); color: white; }
    .primary:hover { background: #1b63b5; }
    .danger { background: #3d1414; color: var(--danger); border: 1px solid var(--danger); }
    .stat-grid { display: grid; gap: 8px; grid-template-columns: repeat(2, 1fr); margin-top: 10px; }
    .stat { background: #101633; border: 1px solid #213066; border-radius: 8px; padding: 8px; }
    .stat b { display: block; font-size: 10px; color: var(--muted); text-transform: uppercase; }
    .stat span { font-size: 16px; font-weight: bold; }
    canvas { width: 100%; background: #0b1026; border-radius: 10px; margin-top: 10px; display: block; }
    .legend { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
  </style>
</head>
<body>

<header style="margin-bottom: 20px;">
  <h1 style="margin:0; color: var(--info);">Race Analyzer Pro <span style="font-size: 12px; color: var(--accent);">v2.0 Metric</span></h1>
  <p style="margin:5px 0; color: var(--muted);">Análisis de frenada en tiempo real • Conversión a KM/H • Auto-Reparación de JSON</p>
</header>

<div class="grid">
  <div class="panel">
    <h3>Entrada de Telemetría</h3>
    <textarea id="jsonInput" rows="15" placeholder="Pega el JSON de Roblox aquí... (Acepta bloques cortados)"></textarea>
    <button class="primary" id="btnProcess">Procesar / Combinar Datos</button>
    <button class="danger" id="btnClear" style="margin-top:20px;">Borrar Sesión</button>
    
    <div class="stat-grid">
      <div class="stat"><b>Distancia</b><span id="stDist">0.00 km</span></div>
      <div class="stat"><b>V. Máx</b><span id="stMaxSpeed">0 km/h</span></div>
      <div class="stat"><b>Tiempo</b><span id="stDuration">0.0s</span></div>
      <div class="stat"><b>Muestras</b><span id="stCount">0</span></div>
    </div>
  </div>

  <div class="panel">
    <h3>Trazado de Pista (GPS)</h3>
    <canvas id="trackCanvas" width="900" height="450"></canvas>
    
    <div class="legend">
      <span><span class="dot" style="background:var(--info)"></span> Trayectoria</span>
      <span><span class="dot" style="background:var(--accent)"></span> Frenado OK</span>
      <span><span class="dot" style="background:var(--danger)"></span> Frenado con Giro</span>
    </div>

    <h3 style="margin-top:25px;">Curva de Velocidad (km/h)</h3>
    <canvas id="speedCanvas" width="900" height="180"></canvas>
  </div>
</div>

<script>
  let state = { lapData: [] };

  function repairJson(text) {
    let raw = text.trim();
    // Limpiar basura al final
    const lastBrace = raw.lastIndexOf('}');
    if (lastBrace !== -1) raw = raw.substring(0, lastBrace + 1);

    // Balancear cierres
    const stack = [];
    for (let char of raw) {
      if (char === '{' || char === '[') stack.push(char === '{' ? '}' : ']');
      else if (char === '}' || char === ']') {
        if (stack.length > 0 && stack[stack.length - 1] === char) stack.pop();
      }
    }
    while (stack.length > 0) raw += stack.pop();

    try {
      const parsed = JSON.parse(raw);
      return parsed.samples || parsed.data || (Array.isArray(parsed) ? parsed : []);
    } catch (e) {
      const matches = raw.match(/\{"time".*?\}/g);
      return matches ? matches.map(m => JSON.parse(m)) : [];
    }
  }

  function drawSpeedGraph(samples) {
    const canvas = document.getElementById('speedCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    const maxSpd = Math.max(...samples.map(s => s.speed * 3.6)) || 100;
    const pad = 20;

    ctx.beginPath();
    ctx.strokeStyle = "#50fa7b";
    ctx.lineWidth = 2;
    
    samples.forEach((s, i) => {
      const x = (i / samples.length) * (canvas.width - pad * 2) + pad;
      const y = canvas.height - ((s.speed * 3.6) / maxSpd * (canvas.height - pad * 2)) - pad;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }

  function renderTrack() {
    if (state.lapData.length === 0) return;
    const samples = state.lapData;
    const canvas = document.getElementById('trackCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const xs = samples.map(s => s.pos.x), zs = samples.map(s => s.pos.z);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minZ = Math.min(...zs), maxZ = Math.max(...zs);
    const scale = Math.min((canvas.width-60)/(maxX-minX || 1), (canvas.height-60)/(maxZ-minZ || 1));

    const getX = (x) => (x - minX) * scale + 30;
    const getZ = (z) => (z - minZ) * scale + 30;

    // Línea de trayectoria
    ctx.beginPath();
    ctx.strokeStyle = "rgba(42, 132, 232, 0.5)";
    ctx.lineWidth = 3;
    samples.forEach((s, i) => {
      if (i === 0) ctx.moveTo(getX(s.pos.x), getZ(s.pos.z));
      else ctx.lineTo(getX(s.pos.x), getZ(s.pos.z));
    });
    ctx.stroke();

    // Puntos de frenada
    let totalDist = 0;
    let maxSpeedKmh = 0;
    samples.forEach((s, i) => {
      const speedKmh = s.speed * 3.6;
      if (speedKmh > maxSpeedKmh) maxSpeedKmh = speedKmh;
      
      if (i > 0) {
        const prev = samples[i-1];
        const d = Math.sqrt(Math.pow(s.pos.x-prev.pos.x,2)+Math.pow(s.pos.z-prev.pos.z,2));
        totalDist += d;

        if (speedKmh < (prev.speed * 3.6) - 1.5) { // Frenando
          ctx.fillStyle = Math.abs(s.steer || 0) > 0.3 ? "var(--danger)" : "var(--accent)";
          ctx.beginPath();
          ctx.arc(getX(s.pos.x), getZ(s.pos.z), 3, 0, Math.PI*2);
          ctx.fill();
        }
      }
    });

    document.getElementById('stDist').innerText = (totalDist / 1000).toFixed(3) + " km";
    document.getElementById('stMaxSpeed').innerText = maxSpeedKmh.toFixed(0) + " km/h";
    document.getElementById('stDuration').innerText = samples[samples.length-1].time.toFixed(1) + "s";
    document.getElementById('stCount').innerText = samples.length;
    
    drawSpeedGraph(samples);
  }

  document.getElementById('btnProcess').onclick = () => {
    const raw = document.getElementById('jsonInput').value;
    const newPoints = repairJson(raw);
    if (newPoints.length > 0) {
      state.lapData.push(...newPoints);
      renderTrack();
      document.getElementById('jsonInput').value = "";
    } else {
      alert("No se detectaron datos válidos.");
    }
  };

  document.getElementById('btnClear').onclick = () => {
    if(confirm("¿Borrar todos los datos actuales?")) location.reload();
  };
</script>
</body>
</html>
