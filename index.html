<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRALYTICS AI - DASHBOARD PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon: #00f2ff; --bg: #0a0a0a; --card: #151515; --danger: #ff4444; --success: #00ff88; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        .layout { display: flex; flex-direction: column; gap: 15px; max-width: 1000px; margin: auto; }
        
        /* Contenedores */
        .card { background: var(--card); border: 1px solid #333; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* Stats */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .stat-box { background: #000; padding: 10px; border-radius: 5px; border-left: 3px solid var(--neon); }
        .stat-box label { font-size: 10px; color: #888; text-transform: uppercase; }
        .stat-box div { font-size: 16px; font-weight: bold; color: #fff; }

        /* Mapa y Gr√°ficas */
        .map-frame { width: 100%; height: 350px; background: #000; border-radius: 5px; position: relative; overflow: hidden; }
        canvas { width: 100% !important; height: 100% !important; }
        
        textarea { width: 100%; height: 60px; background: #000; border: 1px solid #444; color: var(--success); font-family: monospace; border-radius: 5px; margin-top: 10px; box-sizing: border-box; }
        .btn { background: var(--neon); color: #000; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        
        .checkpoint-tag { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div class="layout">
    <div class="card">
        <div class="header">
            <span style="color: var(--neon); font-weight: bold;">üõ∞Ô∏è TERMINAL DE TELEMETR√çA</span>
            <button class="btn" style="width: auto; padding: 5px 15px;" onclick="procesarDatos()">ANALIZAR VUELTA</button>
        </div>
        <textarea id="dataInput" placeholder="Pega aqu√≠ los datos de Roblox..."></textarea>
    </div>

    <div class="stat-grid">
        <div class="stat-box"><label>Pista</label><div id="out-pista">---</div></div>
        <div class="stat-box"><label>Vel. M√°xima</label><div id="out-vel">0 ST/S</div></div>
        <div class="stat-box"><label>Tiempo Est.</label><div id="out-tiempo">00:00.0</div></div>
        <div class="stat-box" style="border-color: var(--danger);"><label>Obst√°culos</label><div id="out-obs">0 Detectados</div></div>
    </div>

    <div class="card">
        <label style="font-size: 12px; color: var(--neon);">üó∫Ô∏è MAPA DE TRAYECTORIA (LiDAR ACTIVO)</label>
        <div class="map-frame">
            <canvas id="mapCanvas"></canvas>
        </div>
    </div>

    <div class="card">
        <label style="font-size: 12px; color: var(--neon);">üìä RENDIMIENTO POR SECTOR Y ALTURA</label>
        <div style="height: 200px;">
            <canvas id="chartSectores"></canvas>
        </div>
    </div>
</div>

<script>
let chartInstance = null;

function procesarDatos() {
    const input = document.getElementById('dataInput').value;
    try {
        const data = JSON.parse(input);
        renderizarTodo(data);
    } catch(e) {
        alert("Error: Datos incompletos o mal copiados.");
    }
}

function renderizarTodo(data) {
    // 1. Estad√≠sticas b√°sicas
    const speeds = data.filter(d => d.speed).map(d => d.speed);
    document.getElementById('out-vel').innerText = Math.max(...speeds).toFixed(1) + " ST/S";
    document.getElementById('out-pista').innerText = "Circuito Detectado";
    
    // 2. Dibujar Mapa (LiDAR)
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    const points = data.filter(d => d.pos);
    const xs = points.map(p => p.pos.x);
    const zs = points.map(p => p.pos.z);
    
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minZ = Math.min(...zs), maxZ = Math.max(...zs);
    const scale = Math.min((canvas.width-40)/(maxX-minX), (canvas.height-40)/(maxZ-minZ));

    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    points.forEach((p, i) => {
        if(i === 0) return;
        const p1 = points[i-1];
        const x1 = (p1.pos.x - minX) * scale + 20;
        const y1 = (p1.pos.z - minZ) * scale + 20;
        const x2 = (p.pos.x - minX) * scale + 20;
        const y2 = (p.pos.z - minZ) * scale + 20;

        // Dibujar rastro de velocidad
        ctx.beginPath();
        let hue = Math.max(0, 200 - (p.speed * 0.8));
        ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
        ctx.lineWidth = 3;
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        // Dibujar Obst√°culos (Radar Negro)
        if(p.distancia_obstaculo < 30) {
            ctx.beginPath();
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            ctx.lineWidth = 1;
            ctx.arc(x2, y2, p.distancia_obstaculo * scale, 0, Math.PI*2);
            ctx.stroke();
        }

        // Marcar Checkpoints
        if(p.isCheckpoint) {
            ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(x2, y2, 5, 0, Math.PI*2); ctx.fill();
        }
    });

    // 3. Gr√°fica de Sectores (Chart.js)
    if(chartInstance) chartInstance.destroy();
    const chartCtx = document.getElementById('chartSectores').getContext('2d');
    
    chartInstance = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: points.map(p => p.time.toFixed(1) + "s"),
            datasets: [{
                label: 'Velocidad',
                data: points.map(p => p.speed),
                borderColor: '#00f2ff',
                borderWidth: 2,
                fill: true,
                backgroundColor: 'rgba(0, 242, 255, 0.1)',
                pointRadius: 0
            },
            {
                label: 'Altura (Monta√±a)',
                data: points.map(p => p.pos.y),
                borderColor: '#ff00ff',
                borderWidth: 1,
                yAxisID: 'y1',
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { display: true, grid: { color: '#222' } },
                y1: { display: false, position: 'right' },
                x: { display: false }
            },
            plugins: { legend: { labels: { color: '#fff', font: { size: 10 } } } }
        }
    });
}
</script>
</body>
</html>
