<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ULTRALYTICS X - ANALIZADOR PROFESIONAL</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #050505; color: #00f2ff; font-family: 'Courier New', monospace; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 1000px; margin: auto; }
        textarea { width: 100%; height: 100px; background: #111; border: 1px solid #00f2ff; color: #0f8; border-radius: 5px; padding: 10px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #00f2ff; color: #000; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .card { background: #111; border: 1px solid #222; border-radius: 8px; padding: 15px; }
        canvas { width: 100% !important; height: auto !important; background: #000; border-radius: 5px; }
        .stat-box { display: flex; justify-content: space-around; text-align: center; margin-bottom: 10px; }
        .stat-val { font-size: 20px; color: #fff; display: block; }
    </style>
</head>
<body>

<div class="grid">
    <h1>üõ∞Ô∏è ULTRALYTICS X-TREME ANALYZER</h1>
    
    <div class="card">
        <textarea id="dataInput" placeholder="Pega el c√≥digo cortado de Roblox aqu√≠..."></textarea>
        <button class="btn" onclick="analizarTodo()">REPARAR Y ANALIZAR FULL</button>
    </div>

    <div id="results" style="display:none;">
        <div class="card stat-box">
            <div><small>VEL. M√ÅX</small><span id="maxSpd" class="stat-val">0</span></div>
            <div><small>PUNTOS</small><span id="ptsCount" class="stat-val">0</span></div>
            <div><small>ESTADO</small><span id="statusTxt" class="stat-val">--</span></div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">üó∫Ô∏è MAPA DE CALOR (VELOCIDAD)</h3>
            <canvas id="mapCanvas"></canvas>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">üìà TELEMETR√çA AVANZADA</h3>
            <canvas id="chartCanvas"></canvas>
        </div>
    </div>
</div>

<script>
let speedChart = null;

function analizarTodo() {
    const input = document.getElementById('dataInput').value.trim();
    const results = document.getElementById('results');
    
    try {
        // --- MOTOR DE REPARACI√ìN ---
        let raw = input;
        let lastBrace = raw.lastIndexOf('}');
        if (lastBrace === -1) throw "No se encontraron datos v√°lidos";
        raw = raw.substring(0, lastBrace + 1);
        if (!raw.startsWith('[')) raw = '[' + raw;
        if (!raw.endsWith(']')) raw = raw + ']';

        const samples = JSON.parse(raw);
        results.style.display = 'block';

        // Stats b√°sicos
        document.getElementById('ptsCount').innerText = samples.length;
        document.getElementById('maxSpd').innerText = Math.max(...samples.map(s => s.speed)).toFixed(1) + " ST/S";
        document.getElementById('statusTxt').innerText = "REPARADO ‚úÖ";

        dibujarMapa(samples);
        dibujarGrafica(samples);

    } catch (e) {
        alert("Error: El texto est√° demasiado da√±ado o no es telemetr√≠a.");
    }
}

function dibujarMapa(samples) {
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 500;

    const xs = samples.map(s => s.pos.x);
    const zs = samples.map(s => s.pos.z);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minZ = Math.min(...zs), maxZ = Math.max(...zs);
    const scale = Math.min(740/(maxX-minX), 440/(maxZ-minZ));

    ctx.clearRect(0,0,800,500);
    ctx.lineWidth = 5;
    ctx.lineCap = "round";

    for(let i=1; i<samples.length; i++) {
        const p1 = samples[i-1], p2 = samples[i];
        const x1 = (p1.pos.x - minX)*scale + 30, y1 = (p1.pos.z - minZ)*scale + 30;
        const x2 = (p2.pos.x - minX)*scale + 30, y2 = (p2.pos.z - minZ)*scale + 30;

        const hue = Math.max(0, 200 - (p2.speed * 1.5));
        ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    }
}

function dibujarGrafica(samples) {
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    if (speedChart) speedChart.destroy();

    speedChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: samples.map(s => s.time.toFixed(1) + "s"),
            datasets: [{
                label: 'Velocidad (Studs/s)',
                data: samples.map(s => s.speed),
                borderColor: '#00f2ff',
                borderWidth: 2,
                fill: true,
                backgroundColor: 'rgba(0, 242, 255, 0.1)',
                pointRadius: 0
            }, {
                label: 'Giro (Steer)',
                data: samples.map(s => (s.steer || 0) * 50), // Escalado para ver
                borderColor: '#ff00ff',
                borderWidth: 1,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            scales: { y: { grid: { color: '#222' } }, x: { grid: { display: false } } }
        }
    });
}
</script>
</body>
</html>
